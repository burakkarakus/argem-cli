#!/usr/bin/env node

import inquirer from"inquirer";import checkbox from"@inquirer/checkbox";import select from"@inquirer/select";import chalk from"chalk";import axios from"axios";import fs from"fs";import os from"os";import figlet from"figlet";const FOLDER_PATH=os.homedir()+"/.argem",FILE_NAME="token.json";function isAlreadyLogedIn(){if(!fs.existsSync(FOLDER_PATH+"/"+FILE_NAME))return!1;try{var e=fs.readFileSync(FOLDER_PATH+"/"+FILE_NAME,{flag:"r",encoding:"utf8"}),t=JSON.parse(e)["authToken"];return!!t}catch(e){return!1}}function persistData(e){fs.mkdirSync(FOLDER_PATH,{recursive:!0}),fs.writeFileSync(FOLDER_PATH+"/"+FILE_NAME,JSON.stringify({})),fs.writeFileSync(FOLDER_PATH+"/"+FILE_NAME,JSON.stringify(e))}function purgeData(){fs.unlinkSync(FOLDER_PATH+"/"+FILE_NAME)}function readData(){try{var e=fs.readFileSync(FOLDER_PATH+"/"+FILE_NAME,{encoding:"utf8",flag:"r"});return JSON.parse(e)}catch(e){return null}}const getLocalizedDay=e=>e.toLocaleString("tr-TR",{weekday:"long"}),getFullDate=e=>{return new Date(e).toLocaleDateString("tr-TR",{year:"numeric",month:"long",day:"numeric"})};function getDateString(e){e=new Date(e);return getFullDate(e)+", "+getLocalizedDay(e)}function doubleDigit(e){return("00"+e).slice(-2)}function calculateMissingTime(e){e=480-(60*Number(e.split(":")[0])+Number(e.split(":")[1]));return doubleDigit(Math.floor(e/60))+":"+doubleDigit(e%60)}class ArgemService{constructor(){this.baseURL="https://argem-sancaktepe.hepsiburada.com/api",this.init()}init=()=>{try{var e=readData()["authToken"];this.instance=null,this.instance=axios.create({headers:{Cookie:"next-auth.session-token="+e},validateStatus:e=>200<=e&&e<=500&&401!==e&&400!==e,baseURL:this.baseURL})}catch(e){}};getTimeTable=()=>this.instance.get("/worklogs",{params:{type:"user",page:1}});getActivities=(e,t)=>this.instance.get("/worklogs/projects",{params:{wid:t,date:e.substring(0,10)}});getProjects=()=>this.instance.get("/lookups");enterWorklog=(e,t,i,r,a)=>this.instance.post("/worklogs",{activity:i,project:r,time:a,type:"OUTSIDE"},{params:{wid:e,date:t.substring(0,10)}})}var ArgemService$1=new ArgemService;async function mainPrompt(){console.log(figlet.textSync("Argem CLI ",{font:"Doom"})),console.log("\n"),isAlreadyLogedIn()||await loginPrompt();var e=await timeTablePrompt();await enterWorkLogPrompt(e,await activityPrompt(e[0].date,e[0].id))}async function loginPrompt(){console.log("Giri≈ü yapmanƒ±z gerekiyor.");var e=(await inquirer.prompt({type:"input",name:"authToken",message:"L√ºtfen next-auth.session-token isimli cookie'yi giriniz:"}))["authToken"];persistData({authToken:e}),ArgemService$1.init()}async function timeTablePrompt(){let e=null;try{var{data:t}=(await ArgemService$1.getTimeTable())["data"];if(!t)throw new Error("Liste bo≈ü olamaz");e=t?.rows?.filter((e,t)=>!e.completed&&t<100&&0<t)}catch(e){return purgeData(),console.log(chalk.red("next-auth.session-token expired olmu≈ü olabilir.")),await loginPrompt(),timeTablePrompt()}e?.length||(console.log(chalk.greenBright("Eksik g√ºn√ºn√ºz bulunmamaktadƒ±r üéâüéâüéâ\n")),process.exit(0));let i=null;for(;!i?.length;)(i=await checkbox({message:"Doldurmak istediƒüiniz g√ºnleri se√ßiniz: ",choices:e.map(e=>({name:getDateString(e.date),value:e.id}))})).length||(process.stdout.moveCursor(0,-1),process.stdout.clearLine(1),console.log(chalk.redBright("Hi√ßbir tarih se√ßmediniz!")));return e.filter(e=>i.includes(e.id))}async function activityPrompt(e,t){var e=(await ArgemService$1.getActivities(e,t))["data"]["data"];return await select({message:"Aktivite se√ßiniz: ",choices:e.map(e=>({name:e.name,value:e.id}))})}async function enterWorkLogPrompt(e,i){console.log("\nArgem giri≈üleriniz ger√ßekle≈ütiriliyor...\n");var{data:t}=(await ArgemService$1.getProjects())["data"];const r=t.find(e=>e.value.toLowerCase().includes("covid"));e.forEach(async e=>{var t=calculateMissingTime(e.totalTime);await ArgemService$1.enterWorklog(e.id,e.date,r.id,i,t),console.log(chalk.greenBright(getDateString(e.date)+` g√ºn√º i√ßin mesai giri≈üi tamamlandƒ±. Girilen toplam mesai s√ºresi: ${t}!`))})}mainPrompt();
